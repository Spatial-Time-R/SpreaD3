\documentclass[english]{paper}


%%%%%%%%%%%%%%%%
%---PACKAGES---%
%%%%%%%%%%%%%%%%
\usepackage[T1]{fontenc}
\usepackage[latin9]{inputenc}
\usepackage{geometry}
\geometry{verbose,tmargin=3cm,bmargin=3cm,lmargin=2cm,rmargin=2cm,headheight=2cm,headsep=2cm,footskip=2cm}
\usepackage{float}
\usepackage{graphicx}
\usepackage{multicol}
\usepackage{hyperref}
\usepackage{babel}
\usepackage{natbib}
\usepackage{booktabs}
\usepackage{multirow}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%---USER SPECIFIED LaTeX COMMANDS---%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\makeatletter

\newenvironment{lyxcode}
{\par\begin{list}{}{
\setlength{\rightmargin}{\leftmargin}
\setlength{\listparindent}{0pt}% needed for AMS classes
\raggedright
\setlength{\itemsep}{0pt}
\setlength{\parsep}{0pt}
\normalfont\ttfamily}%
 \item[]}
{\end{list}}

\graphicspath{{figures/}}

% or sth else
\def \spreadname {SpreaD3}

\makeatother

%%%%%%%%%%%%%%%%
%---DOCUMENT---%
%%%%%%%%%%%%%%%%

\begin{document}

\title{{\spreadname}: Spatial Phylogenetic Reconstruction of Evolutionary Dynamics 3}
\maketitle

\begin{flushleft}
\textbf{Authors}
\par\end{flushleft}

\noindent
Filip Bielejec (\url{filip.bielejec(sorry_spybots)rega.kuleuven.be}) \\
Guy Baele (\url{guy.baele(sorry_spybots)rega.kuleuven.be}) \\
Bram Vrancken  (\url{bram.vrancken(sorry_spybots)rega.kuleuven.be}) \\
Marc Suchard (\url{msuchard(sorry_spybots)ucla.edu})\\
Andrew Rambaut (\url{a.rambaut(sorry_spybots)ed.ac.uk}) \\
Philippe Lemey (\url{philippe.lemey(sorry_spybots)rega.kuleuven.be}) \\

\begin{flushleft}
\textbf{Contact}
\par\end{flushleft}
Filip Bielejec (filip.bielejec@rega.kuleuven.be) 


\begin{flushleft}
\textbf{Download}
\par\end{flushleft}
SpreaD3 and its source code are freely available from \url{https: //github.com/phylogeography/SPREAD2}.
You can also clone the project with Git by running: 
\\\$ git clone https://github.com/phylogeography/SPREAD2. (UPDATE NAME?)
\\
cd into the base dir and compile SpreaD3 by running 
\\\$ ant jar

%---TOC---%
\pagebreak{}
\tableofcontents{}
\pagebreak{}

\section{Introduction}
% 1. Intro
% - Spread is 2-step analysis now 
% - we use JSON as a medium for the pipeline
% - a word of explanation what is JSON notation, how it can be read by
%   any O-O language (python, JS)
% - D3 (what it is etc), what is GEOJSON, how we use it as canvas for our
%   vis, where to get it from, maybe a couple of tips on manipulating
%   GeoJSON files (there are tools to merge, split etc).
% => created separate section for this - software requirements 

% - still some support for KML and GE

SpreaD3 is major rewrite of SPREAD \citep{bielejec11}, a tool for analysing and visualising discrete and continuous trait evolutionary histories associated with phylogenies.
It is designed primarily for use in conjunction with the popular Bayesian phylogenetics software BEAST \citep{drummond:2012zr}.
%These phylogenies are usually temporally resolved, but can also have branch lengths measured in nucleotide substitutions.
%BEAST style annotated file
%To cover both single tree summaries as well as collections of plausible histories (trees), 
%The program is designed to parse BEAST style annotated trees, and thus 
However, it can also accommodate input generated by other phylogenetics inference tools (e.g. MrBayes and BEAST2 or maximum likelihood approaches) as long as the nodes and branches are commented using the appropriate syntax.
\par
The user is offered great flexibility in and control over the visualisation process through two main innovations.
First, each analysis is conceived as a two-step process. 
%separating the parsing and rendering steps
%to maximise flexibility in the visualisation process without a need for the repeated parsing of input data. 
At the parsing step the input is converted to a JavaScript Object Notation (JSON) compliant data file.
Nodes are translated to points, branches to lines and both can have associated annotations. 
Next, the JSON formatted output is used for rendering the visualisations.
By separating the parsing from the rendering, the user can quickly test various image setups without the need for repeatedly parsing the same input.
Note that because JSON is a language-independent data format, the output of the parsing step can be forked to utilities based on several programming languages through dedicated packages and libraries. %examples?
Second, much of the added versatility from this version comes from the newly introduced capability of combining several layers in one illustration. %, as has become default in all widely-used image editors (e.g. Adobe CS, ???).
On the one hand this lifts the restriction of projecting phylogenies on a pre-specified canvas, and gives the user detailed control on the type of map and the displayed %geographical 
attributes (e.g. province borders, altitude contours, \dots). %or no examples? .
At the same time this opens door to mapping traits using any arbitrary coordinate system (see \ref{tips} for an example). 
%are a number of default maps provided? I.e. a world map? where can such input be found? 
A third advantage of the layered approach to image building is the ease with which complex stratified images can be constructed (see \ref{JSONmerge} for an example). 
\par
Alongside enhancing the flexibility in creating the visualisations, the other prime objective of SpreaD3 is to drastically facilitate the on-line publishing of interactive visualisations.
This is achieved by rendering the figures using the Data Driven Documents JavaScript libraries (D3, see \url{www.d3js.org} and \citet{Bostock:2011aa}) to project the annotated phylogenies on a map in geoJSON data structure format (\url{www.geojson.org}).
For reasons of consistency with the previous version, and as an illustration of the branching to other renderers enabled by the versatile JSON data format as a go-between, SpreaD3 also supports re-interpreting parsed input data in the Keyhole Markup Language (KLM) for visualisations in virtual globe software like Google Earth (\url{www.google.com/earth/}). 


\par
In this tutorial we give a detailed description of program functionalities by presenting an example for the main genres of possible analyses and give general guidelines on running SpreaD3. 
The data files used in the example can be found at \url{http://www.phylogeography.org/}.
The user is assumed to know how to build a Maximum Clade Credibility (MCC) tree. 
A good tutorial on how to summarize BEAST trees with TreeAnnotator can be found at \url{???}.

\section{Software requirements}

\section{Usage examples}
%SpreaD3 can process four distinct input types labelled MCC tree with DISCRETE traits, Log file from BSSVS analysis, MCC tree with CONTINUOUS traits, Tree distribution with CONTINUOUS traits. These specify the basic type of analysis performed, with more options available by selecting different parser options for a given input.
% 
% 2. Examples of usage. Whese should show not just how but also why, what
% can we learn by visualising these processes.
% 
For the command line examples throughout this tutorial we assume the following alias has been added to your .bash\_profile:
\\
alias spread=`java -jar <absolute path to spread.jar>' 
\\
The alias will become active when you open another session in Terminal, or it can be used in the current session after executing
\\
\$ source $\sim$/.bash\_profile
\\
in the current session  [\#assuming your bash\_profile resides at \$HOME]. 

\subsection{Visualizing a MCC tree annotated with discrete traits}
% 
% 2.1 MCC tree with discrete traits.
%  - Here we could use the EBOV as a case for study. All the steps Parse
% -> render -> manipulate the visualisation, screenshots etc. Place live links to data (hosted at github)   
% 
%what is this EBOV datasets exactly => pretty needed to claim that the vis leads to additional insights? 
%\\

%H5N1 dataset 
%most recent date: why not automatically set to half of the uncertainty when only known up to year or month? Now manually set to yyyy/06/15?
%$ spread -parse -locations locationCoordinates_H5N1 -tree H5N1_HA_discrete_MCC.tre -locationtrait states -intervals 1 -output parse_states.json -mrsd 2005/06/15
%I would change the name of 'locationtrait' to 'trait'
%in automatic message 'Imported locations' -> the 'locations' should be set to whatever the user has used as trait name
%$ spread -render kml -json parse_states.json -output rendered_states.kml

In this example we use data from the 2014-2015 Ebola virus (EBOV) outbreak in West-Africa. 
To create a JSON data file compatible with KML-based rendering, we parse the MCC tree without passing the corresponding geoJSON map as an argument:
\\
\$ spread -parse -locations locations.txt -tree ebov\_mcc.tree -locationTrait location -intervals 10 -mrsd 2015.8 -output ebov\_discrete\_noMap.json
Note that the number of intervals is set to 10, meaning that xxx.
Also note that when nodes are annotated with two or more trait states, SpreaD3 will randomly pick one of these.  
To create the ready-to-use KML file with the default settings, run
\\
\$ spread -render kml -json ebov\_discrete\_noMap.json -output ebov\_discrete\_noMap.kml
\par
meaning of options?
\\-intervals
\\-header T/F
\\
To project annotated trees on a

Brams-MacBook-Pro:EBOV brammie$ spread -render d3 -json ebov_discrete_withMap.json -output ebov_discrete_withMap 

       SPREAD version 2.1.2 (2015) -- Rough & Ready.
Spatial Phylogenetic Reconstruction Of Evolutionary Dynamics
Authors: Filip Bielejec, Guy Baele, Andrew Rambaut, Marc A. Suchard and Philippe 'The Wise' Lemey
                Thanks to: Stephan Nylinder 

                      The end is near

In rendering mode
java.io.FileNotFoundException: spread2_0.0.1.jar (No such file or directory)
	at java.util.zip.ZipFile.open(Native Method)
	at java.util.zip.ZipFile.<init>(ZipFile.java:220)
	at java.util.zip.ZipFile.<init>(ZipFile.java:150)
	at java.util.jar.JarFile.<init>(JarFile.java:166)
	at java.util.jar.JarFile.<init>(JarFile.java:103)
	at renderers.d3.D3Renderer.render(Unknown Source)
	at app.Spread2ConsoleApp.run(Unknown Source)
	at app.Spread2App.main(Unknown Source)
spread2_0.0.1.jar (No such file or directory)

 
\par
We provide an over view of the options that the user can specify to fine-tune the appearance of the basic elements used for representing the phylogeny, its associated traits and their corresponding uncertainty, namely \textit{points}, \textit{lines} and \textit{counts} in Table \ref{tab:options}.
\\are these available for the KML AND D3 rendering?

%TABLE 1
\vspace{0.5cm}
\begin{table}[!ht]
\centering
\caption[Overview of the available options]{\footnotesize{\textbf{Overview of the available options}}}
\begin{tabular}{ll}
\\
\toprule
			\multicolumn{2}{c}{points}			\\
\midrule	
								&						\\
\textit{color}:					&						\\
								&						\\
override default points color			& -pointColor 0 255 255										\\
map point colors to a continuous attribute 	& -pointColor 0 255 255 -pointColorMapping height					\\
%we should provide an overview of the possible attributes.
map point colors to a discrete attribute:	& 					 									\\
	-same color for all states			&-pointColor 0 255 255 -pointColorMapping location					\\
	-state-specific colors: via color sheet$\dagger$&-pointcolors traitColors.txt -pointColorMapping location		\\
								&						\\
\textit{area}: 					&						\\
								&						\\
map point areas to a continuous attribute	& -pointAreaMapping height									\\
map point areas to a discrete attribute	& -pointAreaMapping location									\\
\midrule
			\multicolumn{2}{c}{lines}			\\
\midrule
								&						\\
\textit{color}:					&						\\
								&						\\
override default lines color				&	-lineColor 250 0 0		\\
map line colors to a continuous attribute	&	-lineColor 250 0 0 -lineColorMapping length				\\
map line colors to a discrete attribute:	&						\\
	-same color for all states			&	-lineColor 250 0 0 -lineColorMapping location				\\
	-state-specific colors: via color sheet$\dagger$&-linecolors traitColors.txt -lineColorMapping location		\\
								&						\\
\textit{width}:					&						\\
								&						\\
	override default lines width		&-lineWidth \textit{number}	\\
								&						\\
								&						\\
\textit{altitude}:				&						\\
								&						\\
override default lines (maximum?) altitude	&-lineAltitude  \textit{number}	\\
map line altitude to a continuous attribute	&-lineAltitude  \textit{number} -lineAltitudeMapping height	\\
map line altitude to a discrete attribute	&-lineAltitude  \textit{number} -lineAltitudeMapping country\\
								&						\\
\midrule
			\multicolumn{2}{c}{counts}				\\
\midrule
								&						\\
\textit{color}:					&						\\
								&						\\
override default count color			&	-countColor 0 0 250		\\
								&						\\
\bottomrule
\end{tabular}
\begin{flushleft}
{\footnotesize 
$\dagger$: a file with per line only the trait state name and its color code, separated by a tab. The colors should be supplied in RGB or RGBA values.
} 
\end{flushleft}
\label{tab:options}
 \end{table}


\subsection{Visualising a MCC tree annotated with continuous traits}
% 2.3 MCC tree with Continuous traits
%  - languages example would look really nice here overlayed on a whole
% world map
% 

\subsection{Visualising a MCC tree annotated with continuous traits}
\label{JSONmerge}
%combine multiple layers


\subsection{Visualising a distribution of trees annotated with continuous traits}


\subsection{Identifying well-supported rates using Bayes factors test}

% 2.2 BF calculation and visualisation
%  - there seems to be a lot of confusion among folks as to what this
% actually does. I've seen them do calculations on binary coefficients
% other than indicators, or dismiss it thinking we do HME to get the BF
% we could use this to mitigate some of that confusion, so write what
% (and how) do we actually calculate these. I suppose a table in a text
% file is of main use but we also show the (graph) visualisation. H5N1 as
% an example?
% 
% - in location coordinates editor there's now 'generate button that will uniformly spread locations over a circle. Show an example of how this can be used to generate a vis (doesn't need a map layer, so no geojson needed). Perhaps more exciting than just a mere graph of BF values
%
\subsection{Time-slicing}
-> to be put under MCC continuous 

% 2.4 time-slicing 
% - West Nile Virus as an example?
% - show how one can use MCC tree to generate the slices or define
% his/her own slice heights
% - merge continuous tree with JSON file resulting form time slicing a
% posterior distribution for a joint visualisation.
% 
% 

\subsection{Tips \& tricks}
\label{tips}
% Tips & Tricks
%  - we should show the antigenic coordinates example here, where the
% coordinates are other than lat/long and there's no underlying map. I
% also have the multiple HPD's example, on which we can sho whow the
% merging works. W parse 3 JSONs for all HPD levels, merg ethem and
% jointly visualise, coloring polygons by HPD levels.
% - antigenic coord (or any other trait for taht matter) coul dbe plotted as a function of time (height attribute)
% - nodes/ branches of a given tree can be anotated in Figtree, these
%   values can then be used as a basis for mapping
% 
% - Some examples of KML rendering, using previously generated JSON files,
%   just to show that we still support it.



\bibliographystyle{apalike}
\bibliography{tutorefs.bib} 

\end{document}
